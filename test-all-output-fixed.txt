
> acr-automotive@1.0.0 test:all
> cross-env NODE_ENV=test tsx scripts/test/run-all-tests.ts

[dotenv@17.2.3] injecting env (4) from .env.test -- tip: ğŸ”„ add secrets lifecycle management: https://dotenvx.com/ops


ğŸ§ª MASTER TEST SUITE - ACR Automotive
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Test Environment: https://fzsdaqpwwbuwkvbzyiax.supabase.co
Expected Project: fzsdaqpwwbuwkvbzyiax
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Safety check passed - using TEST environment


================================================================================
â–¶ï¸  Step 1: Reset Database to Baseline (877 parts)
================================================================================


> acr-automotive@1.0.0 test:reset-db
> cross-env NODE_ENV=test tsx scripts/test/reset-test-db.ts

[dotenv@17.2.3] injecting env (0) from .env.test -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
[dotenv@17.2.3] injecting env (0) from .env.test -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
ğŸ”„ RESETTING TEST DATABASE TO BASELINE

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Safety check passed - using TEST environment
   Database: https://fzsdaqpwwbuwkvbzyiax.supabase.co

Step 1: Looking for golden baseline snapshot...
âœ… Golden snapshot found!
   ID: f5441f5c-de06-49ee-90bc-41e9c4f8e88f
   Created: 11/5/2025, 5:28:21 PM

Step 2: Clearing current database state...
âœ… Database cleared (preserved golden snapshot)

Step 3: Restoring from golden snapshot...
   âœ… Restored 877 parts
   âœ… Restored 1000 vehicle applications
   âœ… Restored 1000 cross references

âœ… Snapshot restoration complete!

Step 4: Verifying restoration...

ğŸ“Š Final Database State:
  Parts: 877
  Vehicle Applications: 1000
  Cross References: 1000

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… DATABASE RESET COMPLETE!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Your test database has been restored to the 877-part baseline state.


âœ… Step 1: Reset Database to Baseline (877 parts) - PASSED (6068ms)


================================================================================
â–¶ï¸  Step 2: Unit Tests (61 tests)
================================================================================

PASS tests/unit/excel/export-service.test.ts
PASS tests/unit/excel/validation-engine.test.ts
  â— Console

    console.log
      
      === ALL ERRORS IN error-invalid-formats.xlsx ===

      at Object.log (tests/unit/excel/validation-engine.test.ts:202:17)

    console.log
      1. [E4_INVALID_UUID_FORMAT] Invalid UUID format: "invalid-uuid-format" (sheet: Parts, row: 2)

      at log (tests/unit/excel/validation-engine.test.ts:204:19)
          at Array.forEach (<anonymous>)

    console.log
      2. [E4_INVALID_UUID_FORMAT] Invalid UUID format: "va-id-1" (sheet: Vehicle Applications, row: 2)

      at log (tests/unit/excel/validation-engine.test.ts:204:19)
          at Array.forEach (<anonymous>)

    console.log
      3. [E4_INVALID_UUID_FORMAT] Invalid UUID format for _part_id: "part-id-1" (sheet: Vehicle Applications, row: 2)

      at log (tests/unit/excel/validation-engine.test.ts:204:19)
          at Array.forEach (<anonymous>)

    console.log
      4. [E5_ORPHANED_FOREIGN_KEY] _part_id "part-id-1" does not reference any part in the Parts sheet (sheet: Vehicle Applications, row: 2)

      at log (tests/unit/excel/validation-engine.test.ts:204:19)
          at Array.forEach (<anonymous>)

    console.log
      5. [E6_INVALID_YEAR_RANGE] End_Year (2020) cannot be before Start_Year (2025) (sheet: Vehicle Applications, row: 2)

      at log (tests/unit/excel/validation-engine.test.ts:204:19)
          at Array.forEach (<anonymous>)

    console.log
      6. [E4_INVALID_UUID_FORMAT] Invalid UUID format: "va-id-2" (sheet: Vehicle Applications, row: 3)

      at log (tests/unit/excel/validation-engine.test.ts:204:19)
          at Array.forEach (<anonymous>)

    console.log
      7. [E4_INVALID_UUID_FORMAT] Invalid UUID format for _part_id: "part-id-1" (sheet: Vehicle Applications, row: 3)

      at log (tests/unit/excel/validation-engine.test.ts:204:19)
          at Array.forEach (<anonymous>)

    console.log
      8. [E5_ORPHANED_FOREIGN_KEY] _part_id "part-id-1" does not reference any part in the Parts sheet (sheet: Vehicle Applications, row: 3)

      at log (tests/unit/excel/validation-engine.test.ts:204:19)
          at Array.forEach (<anonymous>)

    console.log
      9. [E8_YEAR_OUT_OF_RANGE] Start_Year 1899 is out of valid range (1900-2027) (sheet: Vehicle Applications, row: 3)

      at log (tests/unit/excel/validation-engine.test.ts:204:19)
          at Array.forEach (<anonymous>)

    console.log
      
      === WARNING CODES DETECTED ===

      at Object.log (tests/unit/excel/validation-engine.test.ts:244:15)

    console.log
      1. [W1_ACR_SKU_CHANGED] ACR_SKU changed from "SEED-001" to "SEED-001-CHANGED"

      at log (tests/unit/excel/validation-engine.test.ts:246:17)
          at Array.forEach (<anonymous>)

    console.log
      2. [W3_PART_TYPE_CHANGED] Part_Type changed from "Rotor" to "Caliper"

      at log (tests/unit/excel/validation-engine.test.ts:246:17)
          at Array.forEach (<anonymous>)

    console.log
      3. [W4_POSITION_TYPE_CHANGED] Position_Type changed from "Front" to "Rear"

      at log (tests/unit/excel/validation-engine.test.ts:246:17)
          at Array.forEach (<anonymous>)

    console.log
      4. [W7_SPECIFICATIONS_SHORTENED] Specifications shortened from 52 to 16 characters (69% reduction)

      at log (tests/unit/excel/validation-engine.test.ts:246:17)
          at Array.forEach (<anonymous>)

    console.log
      5. [W2_YEAR_RANGE_NARROWED] Year range narrowed from 2010-2015 to 2010-2012

      at log (tests/unit/excel/validation-engine.test.ts:246:17)
          at Array.forEach (<anonymous>)

    console.log
      6. [W8_VEHICLE_MAKE_CHANGED] Make changed from "Honda" to "Toyota"

      at log (tests/unit/excel/validation-engine.test.ts:246:17)
          at Array.forEach (<anonymous>)

    console.log
      7. [W2_YEAR_RANGE_NARROWED] Year range narrowed from 2010-2015 to 2010-2011

      at log (tests/unit/excel/validation-engine.test.ts:246:17)
          at Array.forEach (<anonymous>)

    console.log
      8. [W9_VEHICLE_MODEL_CHANGED] Model changed from "Civic" to "CR-V"

      at log (tests/unit/excel/validation-engine.test.ts:246:17)
          at Array.forEach (<anonymous>)

    console.log
      9. [W2_YEAR_RANGE_NARROWED] Year range narrowed from 2008-2014 to 2010-2012

      at log (tests/unit/excel/validation-engine.test.ts:246:17)
          at Array.forEach (<anonymous>)

    console.log
      10. [W10_COMPETITOR_BRAND_CHANGED] Competitor_Brand changed from "Brembo" to "StopTech"

      at log (tests/unit/excel/validation-engine.test.ts:246:17)
          at Array.forEach (<anonymous>)

PASS tests/unit/excel/import-service-atomic.test.ts
PASS tests/unit/excel/diff-engine.test.ts

Test Suites: 4 passed, 4 total
Tests:       61 passed, 61 total
Snapshots:   0 total
Time:        1.936 s
Ran all test suites matching tests/unit.

âœ… Step 2: Unit Tests (61 tests) - PASSED (3920ms)


================================================================================
â–¶ï¸  Step 3: Integration Tests (22 tests)
================================================================================

PASS tests/integration/malformed-files.test.ts
  â— Console

    console.log
      
      âœ… ALL MALFORMED FILE TESTS COMPLETED

      at log (tests/integration/malformed-files.test.ts:256:11)

    console.log
      
      === EMPTY FILE TEST ===

      at Object.log (tests/integration/malformed-files.test.ts:18:13)

    console.log
      âœ… Empty file rejected as expected

      at Object.log (tests/integration/malformed-files.test.ts:30:13)

    console.log
      
      === PLAIN TEXT FILE TEST ===

      at Object.log (tests/integration/malformed-files.test.ts:34:13)

    console.log
      âœ… Plain text file rejected as expected

      at Object.log (tests/integration/malformed-files.test.ts:52:13)

    console.log
      
      === CSV FILE TEST ===

      at Object.log (tests/integration/malformed-files.test.ts:56:13)

    console.log
      âœ… CSV file rejected as expected

      at Object.log (tests/integration/malformed-files.test.ts:74:13)

    console.log
      
      === CORRUPTED EXCEL FILE TEST ===

      at Object.log (tests/integration/malformed-files.test.ts:78:13)

    console.log
      âœ… Corrupted Excel file rejected as expected

      at Object.log (tests/integration/malformed-files.test.ts:103:13)

    console.log
      
      === MISSING SHEETS TEST ===

      at Object.log (tests/integration/malformed-files.test.ts:107:13)

    console.log
      âœ… Missing sheets validation tested (implementation validated)

      at Object.log (tests/integration/malformed-files.test.ts:114:13)

    console.log
      
      === LARGE FILENAME TEST ===

      at Object.log (tests/integration/malformed-files.test.ts:118:13)

    console.log
      âœ… Long filename handled gracefully

      at Object.log (tests/integration/malformed-files.test.ts:132:13)

    console.log
      
      === UNICODE FILENAME TEST ===

      at Object.log (tests/integration/malformed-files.test.ts:136:13)

    console.log
      âœ… Unicode filename handled correctly

      at Object.log (tests/integration/malformed-files.test.ts:151:13)

    console.log
      
      === SPECIAL CHARACTERS IN DATA TEST ===

      at Object.log (tests/integration/malformed-files.test.ts:155:13)

    console.log
         Validation result: Valid

      at Object.log (tests/integration/malformed-files.test.ts:207:13)

    console.log
         Errors: 0

      at Object.log (tests/integration/malformed-files.test.ts:208:13)

    console.log
         Warnings: 0

      at Object.log (tests/integration/malformed-files.test.ts:209:13)

    console.log
      âœ… Special characters in data handled (validation layer)

      at Object.log (tests/integration/malformed-files.test.ts:215:13)

    console.log
      
      === WRONG MIME TYPE TEST ===

      at Object.log (tests/integration/malformed-files.test.ts:219:13)

    console.log
      âœ… Wrong MIME type handled (content-based validation)

      at Object.log (tests/integration/malformed-files.test.ts:238:13)

    console.log
      
      === ZERO-BYTE FILE TEST ===

      at Object.log (tests/integration/malformed-files.test.ts:242:13)

    console.log
      âœ… Zero-byte file rejected as expected

      at Object.log (tests/integration/malformed-files.test.ts:253:13)

PASS tests/integration/large-dataset.test.ts
  â— Console

    console.log
      
      === LARGE DATASET GENERATION TEST ===

      at Object.log (tests/integration/large-dataset.test.ts:27:13)

    console.log
      ğŸ“Š Generating 10,000 parts...

      at Object.log (tests/integration/large-dataset.test.ts:28:13)

    console.log
      âœ… Generated in 3ms (3333333 parts/sec)

      at Object.log (tests/integration/large-dataset.test.ts:48:13)

    console.log
      ğŸ“ Creating Excel workbook...

      at Object.log (tests/integration/large-dataset.test.ts:51:13)

    console.log
      âœ… Workbook created in 66ms

      at Object.log (tests/integration/large-dataset.test.ts:96:13)

    console.log
      ğŸ’¾ Converting to binary...

      at Object.log (tests/integration/large-dataset.test.ts:99:13)

    console.log
      âœ… Binary created in 524ms (0MB)

      at Object.log (tests/integration/large-dataset.test.ts:104:13)

    console.log
      
      â±ï¸  Total generation time: 595ms

      at Object.log (tests/integration/large-dataset.test.ts:123:13)

    console.log
      ğŸ” Parsing Excel file...

      at Object.log (tests/integration/large-dataset.test.ts:126:13)

    console.log
      âœ… Parsed in 341ms (29326 parts/sec)

      at Object.log (tests/integration/large-dataset.test.ts:132:13)

    console.log
      âœ”ï¸  Validating data...

      at Object.log (tests/integration/large-dataset.test.ts:142:13)

    console.log
      âœ… Validated in 10ms

      at Object.log (tests/integration/large-dataset.test.ts:153:13)

    console.log
      ğŸ”„ Generating diff...

      at Object.log (tests/integration/large-dataset.test.ts:169:13)

    console.log
      âœ… Diff generated in 2ms

      at Object.log (tests/integration/large-dataset.test.ts:180:13)

    console.log
      
      ğŸ“Š Performance Summary:

      at Object.log (tests/integration/large-dataset.test.ts:185:13)

    console.log
         Generation: 3ms

      at Object.log (tests/integration/large-dataset.test.ts:186:13)

    console.log
         Workbook:   66ms

      at Object.log (tests/integration/large-dataset.test.ts:187:13)

    console.log
         Binary:     524ms

      at Object.log (tests/integration/large-dataset.test.ts:188:13)

    console.log
         Parse:      341ms

      at Object.log (tests/integration/large-dataset.test.ts:189:13)

    console.log
         Validation: 10ms

      at Object.log (tests/integration/large-dataset.test.ts:190:13)

    console.log
         Diff:       2ms

      at Object.log (tests/integration/large-dataset.test.ts:191:13)

    console.log
         Total:      949ms (0.9s)

      at Object.log (tests/integration/large-dataset.test.ts:192:13)

    console.log
      
      âœ… LARGE DATASET MEMORY TEST PASSED

      at Object.log (tests/integration/large-dataset.test.ts:199:13)

    console.log
      
      === LARGE DATASET DATABASE IMPORT TEST ===

      at Object.log (tests/integration/large-dataset.test.ts:203:13)

    console.log
      âš ï¸  WARNING: This test will add 10,000 parts to the database!

      at Object.log (tests/integration/large-dataset.test.ts:204:13)

    console.log
      âš ï¸  Only run this on a clean test database

      at Object.log (tests/integration/large-dataset.test.ts:205:13)

    console.log
      â­ï¸  Skipping database import test (requires manual activation)

      at Object.log (tests/integration/large-dataset.test.ts:209:13)

    console.log
      ğŸ’¡ To enable: Remove the early return in large-dataset.test.ts

      at Object.log (tests/integration/large-dataset.test.ts:210:13)

FAIL tests/integration/rollback-edge-cases.test.ts (7.44 s)
  â— Console

    console.log
      
      âœ… ALL ROLLBACK EDGE CASE TESTS COMPLETED

      at log (tests/integration/rollback-edge-cases.test.ts:268:11)

    console.log
      
      === NO SNAPSHOTS TEST ===

      at Object.log (tests/integration/rollback-edge-cases.test.ts:53:13)

    console.log
         Found 1 snapshots

      at Object.log (tests/integration/rollback-edge-cases.test.ts:59:13)

    console.log
      â­ï¸  Skipping (snapshots exist in database)

      at Object.log (tests/integration/rollback-edge-cases.test.ts:71:15)

    console.log
      
      === DOUBLE ROLLBACK TEST ===

      at Object.log (tests/integration/rollback-edge-cases.test.ts:76:13)

    console.log
         Initial snapshots: 1

      at Object.log (tests/integration/rollback-edge-cases.test.ts:89:13)

    console.log
         Latest snapshot ID: f5441f5c-de06-49ee-90bc-41e9c4f8e88f

      at Object.log (tests/integration/rollback-edge-cases.test.ts:94:15)

    console.log
         Snapshot created: 2025-11-05T23:28:21.961Z

      at Object.log (tests/integration/rollback-edge-cases.test.ts:95:15)

    console.log
      ğŸ”„ Executing first rollback...

      at Object.log (tests/integration/rollback-edge-cases.test.ts:98:15)

    console.log
      [RollbackService] Starting rollback to import: f5441f5c-de06-49ee-90bc-41e9c4f8e88f

      at RollbackService.log [as rollbackToImport] (src/services/excel/rollback/RollbackService.ts:50:15)

    console.log
      [RollbackService] Sequential enforcement validated

      at RollbackService.log [as rollbackToImport] (src/services/excel/rollback/RollbackService.ts:54:15)

    console.log
      [RollbackService] Import record loaded: {
        fileName: 'GOLDEN_BASELINE_877.xlsx',
        createdAt: '2025-11-05T23:28:21.961741+00:00',
        rowsImported: 2877
      }

      at RollbackService.log [as rollbackToImport] (src/services/excel/rollback/RollbackService.ts:67:15)

    console.log
      [RollbackService] Checking for conflicts...

      at RollbackService.log [as validateRollbackSafety] (src/services/excel/rollback/RollbackService.ts:190:13)

    console.log
      [RollbackService] Import timestamp: 2025-11-05T23:28:21.961741+00:00

      at RollbackService.log [as validateRollbackSafety] (src/services/excel/rollback/RollbackService.ts:191:13)

    console.log
      [RollbackService] No conflicts found - safe to proceed

      at RollbackService.log [as validateRollbackSafety] (src/services/excel/rollback/RollbackService.ts:235:13)

    console.log
      [RollbackService] No conflicts detected - safe to rollback

      at RollbackService.log [as rollbackToImport] (src/services/excel/rollback/RollbackService.ts:75:15)

    console.log
      [RollbackService] Snapshot loaded: { parts: 877, vehicleApplications: 1000, crossReferences: 1000 }

      at RollbackService.log [as rollbackToImport] (src/services/excel/rollback/RollbackService.ts:79:15)

    console.log
      [RollbackService] Deleting current data...

      at RollbackService.log [as deleteAllData] (src/services/excel/rollback/RollbackService.ts:249:13)

    console.log
      [RollbackService] All current data deleted

      at RollbackService.log [as deleteAllData] (src/services/excel/rollback/RollbackService.ts:293:13)

    console.log
      [RollbackService] Current data deleted

      at RollbackService.log [as rollbackToImport] (src/services/excel/rollback/RollbackService.ts:87:15)

    console.log
      [RollbackService] Restoring snapshot data...

      at RollbackService.log [as restoreSnapshotData] (src/services/excel/rollback/RollbackService.ts:312:13)

    console.log
      [RollbackService] Restoring 877 parts...

      at RollbackService.log [as restoreSnapshotData] (src/services/excel/rollback/RollbackService.ts:316:15)

    console.log
      [RollbackService] Restoring 1000 vehicle applications...

      at RollbackService.log [as restoreSnapshotData] (src/services/excel/rollback/RollbackService.ts:326:15)

    console.log
      [RollbackService] Restoring 1000 cross references...

      at RollbackService.log [as restoreSnapshotData] (src/services/excel/rollback/RollbackService.ts:340:15)

    console.log
      [RollbackService] Snapshot data restored successfully

      at RollbackService.log [as restoreSnapshotData] (src/services/excel/rollback/RollbackService.ts:352:13)

    console.log
      [RollbackService] Snapshot data restored

      at RollbackService.log [as rollbackToImport] (src/services/excel/rollback/RollbackService.ts:91:15)

    console.log
      [RollbackService] Consumed snapshot deleted

      at RollbackService.log [as rollbackToImport] (src/services/excel/rollback/RollbackService.ts:103:17)

    console.log
      [RollbackService] Rollback completed in 4425ms

      at RollbackService.log [as rollbackToImport] (src/services/excel/rollback/RollbackService.ts:107:15)

    console.log
      âœ… First rollback completed in 4425ms

      at Object.log (tests/integration/rollback-edge-cases.test.ts:100:15)

    console.log
      ğŸ”„ Attempting second rollback of same snapshot...

      at Object.log (tests/integration/rollback-edge-cases.test.ts:103:15)

    console.log
      [RollbackService] Starting rollback to import: f5441f5c-de06-49ee-90bc-41e9c4f8e88f

      at RollbackService.log [as rollbackToImport] (src/services/excel/rollback/RollbackService.ts:50:15)

    console.log
      
      === CORRUPTED SNAPSHOT TEST ===

      at Object.log (tests/integration/rollback-edge-cases.test.ts:115:13)

    console.log
      â­ï¸  No snapshots to validate

      at Object.log (tests/integration/rollback-edge-cases.test.ts:140:15)

    console.log
      
      === EMPTY DIFF ROLLBACK TEST ===

      at Object.log (tests/integration/rollback-edge-cases.test.ts:145:13)

    console.log
      â­ï¸  Test scenario: Rollback of no-op import

      at Object.log (tests/integration/rollback-edge-cases.test.ts:150:13)

    console.log
      ğŸ’¡ This would require importing data identical to existing state

      at Object.log (tests/integration/rollback-edge-cases.test.ts:151:13)

    console.log
      ğŸ’¡ Then rolling back - snapshot exists but restore is no-op

      at Object.log (tests/integration/rollback-edge-cases.test.ts:152:13)

    console.log
      âœ… Conceptual test - implementation handles this correctly

      at Object.log (tests/integration/rollback-edge-cases.test.ts:153:13)

    console.log
      
      === SEQUENTIAL ROLLBACK TEST ===

      at Object.log (tests/integration/rollback-edge-cases.test.ts:157:13)

    console.log
      â­ï¸  Need at least 2 snapshots to test sequential rollback

      at Object.log (tests/integration/rollback-edge-cases.test.ts:181:15)

    console.log
      
      === DATABASE CONNECTION TEST ===

      at Object.log (tests/integration/rollback-edge-cases.test.ts:186:13)

    console.log
         Testing with invalid UUID format...

      at Object.log (tests/integration/rollback-edge-cases.test.ts:194:13)

    console.log
      [RollbackService] Starting rollback to import: not-a-valid-uuid

      at RollbackService.log [as rollbackToImport] (src/services/excel/rollback/RollbackService.ts:50:15)

    console.log
      âœ… Invalid UUID handled gracefully

      at Object.log (tests/integration/rollback-edge-cases.test.ts:199:13)

    console.log
         Testing with non-existent UUID...

      at Object.log (tests/integration/rollback-edge-cases.test.ts:202:13)

    console.log
      [RollbackService] Starting rollback to import: 00000000-0000-0000-0000-000000000000

      at RollbackService.log [as rollbackToImport] (src/services/excel/rollback/RollbackService.ts:50:15)

    console.log
      âœ… Non-existent snapshot handled gracefully

      at Object.log (tests/integration/rollback-edge-cases.test.ts:207:13)

    console.log
      
      === LARGE SNAPSHOT TEST ===

      at Object.log (tests/integration/rollback-edge-cases.test.ts:211:13)

    console.log
      â­ï¸  No snapshots to measure

      at Object.log (tests/integration/rollback-edge-cases.test.ts:237:15)

    console.log
      
      === SNAPSHOT CLEANUP TEST ===

      at Object.log (tests/integration/rollback-edge-cases.test.ts:242:13)

    console.log
         Snapshots before: 0

      at Object.log (tests/integration/rollback-edge-cases.test.ts:247:13)

    console.log
      â­ï¸  No snapshots available for cleanup test

      at Object.log (tests/integration/rollback-edge-cases.test.ts:264:15)

  â— Rollback Edge Cases Test â€º should handle rollback of already-rolled-back snapshot

    expect(received).rejects.toThrow(expected)

    Expected pattern: /already been rolled back|not found|does not exist/i
    Received message: "No import snapshots available"

        [0m [90m 154 |[39m
         [90m 155 |[39m     [36mif[39m ([33m![39msnapshots [33m||[39m snapshots[33m.[39mlength [33m===[39m [35m0[39m) {
        [31m[1m>[22m[39m[90m 156 |[39m       [36mthrow[39m [36mnew[39m [33mError[39m([32m'No import snapshots available'[39m)[33m;[39m
         [90m     |[39m             [31m[1m^[22m[39m
         [90m 157 |[39m     }
         [90m 158 |[39m
         [90m 159 |[39m     [90m// Must be the newest snapshot[39m[0m

      at RollbackService.validateSequentialRollback (src/services/excel/rollback/RollbackService.ts:156:13)
      at RollbackService.rollbackToImport (src/services/excel/rollback/RollbackService.ts:53:7)
      at Object.<anonymous> (tests/integration/rollback-edge-cases.test.ts:104:7)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.toThrow (tests/integration/rollback-edge-cases.test.ts:106:17)

Test Suites: 1 failed, 2 passed, 3 total
Tests:       1 failed, 19 passed, 20 total
Snapshots:   0 total
Time:        8.299 s
Ran all test suites matching tests/integration.

âŒ Step 3: Integration Tests (22 tests) - FAILED (10144ms)


================================================================================
â–¶ï¸  Step 4: Full Pipeline Test (import + rollback)
================================================================================


> acr-automotive@1.0.0 test:full-pipeline
> cross-env NODE_ENV=test tsx scripts/test/test-full-import-pipeline.ts

[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ğŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ğŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
ğŸ§ª Testing FULL Import Pipeline (with database modifications)

âš ï¸  WARNING: This will modify the database!
âš ï¸  Make sure you're using a TEST database

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ Test File: c:\Users\abelm\Projects\acr-automotive\tmp\baseline-export.xlsx
   Size: 167 KB
   Modified: 10/29/2025, 3:21:23 PM

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 1: Parse Excel File
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â³ Parsing Excel file...
âœ… Parsed in 163ms
   Parts: 877 rows
   Vehicle Applications: 1000 rows
   Cross References: 1000 rows

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 2: Fetch Existing Database Data
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â³ Fetching current data from database...
âœ… Fetched in 1172ms
   Parts: 877 records
   Vehicle Applications: 1000 records
   Cross References: 1000 records

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 3: Validate Data
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â³ Running validation engine...
âœ… Validated in 18ms
   Valid: âœ… Yes
   Errors: 0
   Warnings: 0

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 4: Generate Diff (Change Detection)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â³ Running diff engine...
âœ… Diff generated in 3ms

ğŸ“Š Changes Detected:
   â• Total Adds: 0
   ğŸ”„ Total Updates: 1000
   â– Total Deletes: 0
   ğŸ“ Total Changes: 1000

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 5: Execute Import (Creates Snapshot)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸  About to MODIFY DATABASE...
â³ Creating snapshot and executing import...

[ImportService] Starting import execution...
[ImportService] Changes: {
  totalAdds: 0,
  totalUpdates: 1000,
  totalDeletes: 0,
  totalUnchanged: 1877,
  totalChanges: 1000,
  changesBySheet: { parts: 0, vehicleApplications: 0, crossReferences: 1000 }
}
[ImportService] Snapshot stats: { parts: 877, vehicle_applications: 1000, cross_references: 1000 }
[ImportService] Pre-import snapshot created
[ImportService] Executing atomic import transaction...
[ImportService] Transaction payload: {
  partsToAdd: 0,
  partsToUpdate: 0,
  vehiclesToAdd: 0,
  vehiclesToUpdate: 0,
  crossRefsToAdd: 0,
  crossRefsToUpdate: 1000
}
[ImportService] Attempt 1/3...
[ImportService] Transaction completed successfully: {
  parts_added: 0,
  parts_updated: 0,
  vehicles_added: 0,
  vehicles_updated: 0,
  cross_refs_added: 0,
  cross_refs_updated: 1000
}
[ImportService] Bulk operations completed in 761ms
[ImportService] Import history saved: 281640c4-20e0-4794-a1e4-dd2eb89ab5da
[ImportService] Auto-cleanup will keep last 3 snapshots
âœ… Import completed in 1825ms
   Import ID: 281640c4-20e0-4794-a1e4-dd2eb89ab5da
   Changes Applied: 1000
   Snapshot Created: âœ… Yes

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 6: Verify Snapshot
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â³ Fetching import history record...
âœ… Snapshot verified

ğŸ“‹ Import History Record:
   ID: 281640c4-20e0-4794-a1e4-dd2eb89ab5da
   File: test-export.xlsx
   Size: 167 KB
   Rows Imported: 1000
   Created At: 11/5/2025, 5:35:32 PM

ğŸ“Š Snapshot Data:
   Parts: 877 records
   Vehicle Apps: 1000 records
   Cross Refs: 1000 records
   Timestamp: 2025-11-05T23:35:31.577Z

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 7: Test Rollback
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸  About to ROLLBACK import (restore snapshot)...
â³ Executing rollback...

[RollbackService] Starting rollback to import: 281640c4-20e0-4794-a1e4-dd2eb89ab5da
[RollbackService] Sequential enforcement validated
[RollbackService] Import record loaded: {
  fileName: 'test-export.xlsx',
  createdAt: '2025-11-05T23:35:32.438385+00:00',
  rowsImported: 1000
}
[RollbackService] Checking for conflicts...
[RollbackService] Import timestamp: 2025-11-05T23:35:32.438385+00:00
[RollbackService] No conflicts found - safe to proceed
[RollbackService] No conflicts detected - safe to rollback
[RollbackService] Snapshot loaded: { parts: 877, vehicleApplications: 1000, crossReferences: 1000 }
[RollbackService] Deleting current data...
[RollbackService] All current data deleted
[RollbackService] Current data deleted
[RollbackService] Restoring snapshot data...
[RollbackService] Restoring 877 parts...
[RollbackService] Restoring 1000 vehicle applications...
[RollbackService] Restoring 1000 cross references...
[RollbackService] Snapshot data restored successfully
[RollbackService] Snapshot data restored
[RollbackService] Consumed snapshot deleted
[RollbackService] Rollback completed in 2099ms
âœ… Rollback completed in 2099ms
   Import ID: 281640c4-20e0-4794-a1e4-dd2eb89ab5da
   Parts Restored: 877
   Vehicle Apps Restored: 1000
   Cross Refs Restored: 1000

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 8: Verify Rollback
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â³ Checking if snapshot was consumed...
âœ… Snapshot consumed (deleted after rollback)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… FULL PIPELINE TEST COMPLETE

ğŸ“‹ Performance Summary:
   Parse: 163ms
   Database Fetch: 1172ms
   Validation: 18ms
   Diff: 3ms
   Import (with snapshot): 1825ms
   Rollback (restore snapshot): 2099ms
   â±ï¸  Total: 5280ms

âœ… All systems operational!
   - ImportService âœ…
   - Snapshot creation âœ…
   - RollbackService âœ…
   - Snapshot restoration âœ…

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”’ Final safety check...
   âœ… Already cleaned up

âœ… Step 4: Full Pipeline Test (import + rollback) - PASSED (7404ms)


================================================================================
â–¶ï¸  Step 5: Final Reset to Baseline
================================================================================


> acr-automotive@1.0.0 test:reset-db
> cross-env NODE_ENV=test tsx scripts/test/reset-test-db.ts

[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ğŸ” encrypt with Dotenvx: https://dotenvx.com
[dotenv@17.2.3] injecting env (0) from .env.test -- tip: âš™ï¸  enable debug logging with { debug: true }
ğŸ”„ RESETTING TEST DATABASE TO BASELINE

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Safety check passed - using TEST environment
   Database: https://fzsdaqpwwbuwkvbzyiax.supabase.co

Step 1: Looking for golden baseline snapshot...
âš ï¸  Golden snapshot not found - creating new one...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
This is a one-time setup - future resets will be faster!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[dotenv@17.2.3] injecting env (0) from .env.test -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

ğŸ“¸ GOLDEN BASELINE SNAPSHOT SETUP

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Safety check passed - using TEST environment
   Database: https://fzsdaqpwwbuwkvbzyiax.supabase.co

Step 1: Checking for existing golden snapshot...
âš ï¸  No golden snapshot found - will create new one

Step 2: Clearing database...
âœ… Database cleared

Step 3: Loading baseline-export.xlsx...
âœ… File loaded (166.65 KB)

Step 4: Parsing Excel file...
âœ… Parsed:
   Parts: 877
   Vehicle Applications: 1000
   Cross References: 1000

Step 5: Skipping validation (baseline creation)...
âœ… Baseline data will be inserted with original UUIDs preserved

Step 6: Generating diff...
âœ… Diff generated:
   Adds: 2877
   Updates: 0
   Deletes: 0

Step 7: Executing import directly (no snapshot needed yet)...
[ImportService] Executing atomic import transaction...
[ImportService] Transaction payload: {
  partsToAdd: 877,
  partsToUpdate: 0,
  vehiclesToAdd: 1000,
  vehiclesToUpdate: 0,
  crossRefsToAdd: 1000,
  crossRefsToUpdate: 0
}
[ImportService] Attempt 1/3...
[ImportService] Transaction completed successfully: {
  parts_added: 877,
  parts_updated: 0,
  vehicles_added: 1000,
  vehicles_updated: 0,
  cross_refs_added: 1000,
  cross_refs_updated: 0
}
âœ… Import completed!
   Changes Applied: 2877

Step 8: Creating golden snapshot (POST-import state)...
   Captured data:
   Parts: 877
   Vehicle Applications: 1000
   Cross References: 1000

âœ… Golden snapshot verified:
   ID: 5adec8c5-b88c-4af6-903d-76af079ab685
   Filename: GOLDEN_BASELINE_877.xlsx
   Parts: 877
   Vehicle Applications: 1000
   Cross References: 1000

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ‰ GOLDEN BASELINE SNAPSHOT CREATED!

This snapshot will be used by all tests for fast database resets.
Snapshot ID: 5adec8c5-b88c-4af6-903d-76af079ab685


âœ… Golden snapshot created successfully!
   Snapshot ID: 5adec8c5-b88c-4af6-903d-76af079ab685

ğŸ’¡ Future database resets will use this snapshot (~2s vs ~5s)


âœ… Step 5: Final Reset to Baseline - PASSED (5036ms)


================================================================================
â–¶ï¸  Step 6: Verify Database State
================================================================================

[dotenv@17.2.3] injecting env (0) from .env.test -- tip: ğŸ” encrypt with Dotenvx: https://dotenvx.com
ğŸ” Verifying database state after rollbacks...

ğŸ“Š Current Database State:
  Parts: 0
  Vehicle Applications: 1000
  Cross References: 1000

ğŸ“œ Import History: 1 snapshots

âš ï¸  Remaining snapshots:
  - GOLDEN_BASELINE_877.xlsx (11/5/2025, 5:35:40 PM)

ğŸ” Parts with updated_by='import': 877
  âš ï¸  WARNING: Some parts still marked as imported!
  Sample: ACR10094077, ACR10094254, ACR10124926

ğŸ“¦ Sample Parts (first 5):

âœ… Verification complete!

Expected baseline state:
  - 877 parts (original baseline-export.xlsx)
  - 0 import history snapshots
  - All parts should have updated_by="system" or null

âœ… Step 6: Verify Database State - PASSED (2751ms)



â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š TEST SUITE SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… PASS - Step 1: Reset Database to Baseline (877 parts) (6068ms)
âœ… PASS - Step 2: Unit Tests (61 tests) (3920ms)
âŒ FAIL - Step 3: Integration Tests (22 tests) (10144ms)
       Error: Command failed: npx jest tests/integration --no-coverage
âœ… PASS - Step 4: Full Pipeline Test (import + rollback) (7404ms)
âœ… PASS - Step 5: Final Reset to Baseline (5036ms)
âœ… PASS - Step 6: Verify Database State (2751ms)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total: 6 steps
Passed: 5
Failed: 1
Duration: 35323ms (35.3s)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ’¥ SOME TESTS FAILED

âŒ 1 step(s) failed
   Review the output above for details

