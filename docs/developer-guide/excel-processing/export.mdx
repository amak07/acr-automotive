---
title: "Export Architecture"
description: "Pagination bypass, hidden columns, and multi-sheet workbook generation"
---

## Export Architecture

The export system generates Excel files with three normalized sheets containing hidden ID columns for round-trip editing. Built with ExcelJS for full Excel feature support including column visibility, frozen headers, and proper formatting.

### Why ExcelJS Over SheetJS

ACR's export system uses ExcelJS, not the more common SheetJS library. This decision came down to a critical feature: hidden columns.

The export-import workflow requires hidden ID columns (`_id`, `_part_id`, `_acr_part_id`) that store UUIDs for matching on re-import. These columns must be:
1. Present in the file (data intact for import service)
2. Hidden by default (Humberto sees ACR_SKU, not UUIDs)
3. Accessible if needed (can unhide manually to debug)

SheetJS requires a Pro license ($$$) for the `column.hidden` property. ExcelJS provides this in the free community edition. Since ACR is bootstrapped with no recurring software costs, ExcelJS was the obvious choice.

**Additional benefits of ExcelJS**:
- Frozen panes (headers stay visible when scrolling thousands of rows)
- Full column width control (UUIDs get 36 chars, SKUs get 15)
- Robust cell formatting (dates, numbers, text)

### Pagination Strategy: Bypassing PostgREST Limits

Supabase's PostgREST has a server-side max-rows limit (default 1000). For exports, this is a problem: ACR has 877 parts, 2,304 vehicle applications, and 6,412 cross-references. A naive query would return only the first 1,000 rows, silently dropping thousands of records.

The solution uses range-based pagination:

```typescript
// File: src/services/export/ExcelExportService.ts (lines 52-85)
private async fetchAllRows(tableName: string, orderBy: string): Promise<any[]> {
  const PAGE_SIZE = 1000;
  let allRows: any[] = [];
  let start = 0;
  let hasMore = true;

  while (hasMore) {
    const { data, error } = await supabase
      .from(tableName)
      .select('*')
      .order(orderBy, { ascending: true })
      .range(start, start + PAGE_SIZE - 1);  // Key: range() for pagination

    if (error) throw new Error(`Failed to fetch ${tableName}: ${error.message}`);

    if (data && data.length > 0) {
      allRows = allRows.concat(data);
      start += PAGE_SIZE;
      hasMore = data.length === PAGE_SIZE; // Full page = more rows exist
    } else {
      hasMore = false; // Empty or partial page = end reached
    }
  }

  return allRows;
}
```

**How it works**: The `.range(start, end)` method tells PostgREST to return rows `start` through `end` (inclusive, 0-indexed). By incrementing `start` by `PAGE_SIZE` after each fetch, we walk through the full table:
- Query 1: rows 0-999 (1000 rows)
- Query 2: rows 1000-1999 (1000 rows)
- Query 3: rows 2000-2999 (1000 rows)
- Query 4: rows 3000-3303 (304 rows) ← partial page signals end

**Loop termination**: When `data.length < PAGE_SIZE`, we've hit the last page. Setting `hasMore = false` breaks the loop.

**Performance**: All three tables (parts, vehicles, cross-refs) are fetched in parallel using `Promise.all()`. Total: ~11 database queries executing concurrently, not sequentially.

### Multi-Sheet Structure with Hidden Columns

Excel files contain three sheets with a normalized structure matching the database schema:

**Sheet 1: Parts** (877 rows)
| Column | Header | Width | Hidden | Purpose |
|--------|--------|-------|--------|---------|
| A | `_id` | 36 | ✓ | Part UUID for update matching |
| B | `ACR_SKU` | 15 | ✗ | Part number (user-visible) |
| C | `Part_Type` | 20 | ✗ | Brake Caliper, Wheel Hub, etc. |
| D | `Position_Type` | 15 | ✗ | Front, Rear, Front Left, etc. |
| E | `ABS_Type` | 15 | ✗ | With ABS, Without ABS |
| F | `Bolt_Pattern` | 15 | ✗ | 5x120, 6x139.7, etc. |
| G | `Drive_Type` | 15 | ✗ | 2WD, 4WD, AWD |
| H | `Specifications` | 40 | ✗ | Technical details |

**Sheet 2: Vehicle Applications** (2,304 rows)
| Column | Header | Width | Hidden | Purpose |
|--------|--------|-------|--------|---------|
| A | `_id` | 36 | ✓ | Vehicle application UUID |
| B | `_part_id` | 36 | ✓ | Foreign key to parts table |
| C | `ACR_SKU` | 15 | ✗ | Part number (joined for readability) |
| D | `Make` | 15 | ✗ | HONDA, TOYOTA, CHEVROLET |
| E | `Model` | 20 | ✗ | CIVIC, CAMRY, SILVERADO |
| F | `Start_Year` | 12 | ✗ | First year of fitment (2005) |
| G | `End_Year` | 12 | ✗ | Last year of fitment (2010) |

**Sheet 3: Cross References** (6,412 rows)
| Column | Header | Width | Hidden | Purpose |
|--------|--------|-------|--------|---------|
| A | `_id` | 36 | ✓ | Cross-reference UUID |
| B | `_acr_part_id` | 36 | ✓ | Foreign key to parts table |
| C | `ACR_SKU` | 15 | ✗ | Part number (joined for readability) |
| D | `Competitor_Brand` | 20 | ✗ | TRW, MOTORCRAFT, RAYBESTOS |
| E | `Competitor_SKU` | 20 | ✗ | TM515072, BR930625, 96626 |

**Hidden column implementation** with ExcelJS:

```typescript
// File: src/services/excel/shared/constants.ts (lines 203-212)
export const PARTS_COLUMNS = [
  { header: '_id', key: '_id', width: 36, hidden: true },  // Hidden
  { header: 'ACR_SKU', key: 'acr_sku', width: 15 },        // Visible
  { header: 'Part_Type', key: 'part_type', width: 20 },
  // ... more visible columns
];

// File: src/services/export/ExcelExportService.ts (lines 125-135)
private addPartsSheet(workbook: ExcelJS.Workbook, parts: any[]): void {
  const worksheet = workbook.addWorksheet('Parts');
  worksheet.columns = PARTS_COLUMNS;  // ExcelJS applies hidden: true
  worksheet.views = [{ state: 'frozen', ySplit: 1 }];  // Freeze header row

  parts.forEach(part => {
    worksheet.addRow({
      _id: part.id,              // Populated but hidden
      acr_sku: part.acr_sku,     // Visible
      part_type: part.part_type,
      // ...
    });
  });
}
```

When Excel opens the file, column A is hidden by the `hidden: true` property in the XML. Users see column B (`ACR_SKU`) as the first visible column. They can manually unhide if needed: Right-click column B → Unhide.

### Frozen Headers for Usability

```typescript
// File: src/services/export/ExcelExportService.ts (line 128)
worksheet.views = [{ state: 'frozen', ySplit: 1 }];
```

This freezes the first row (header row) so it stays visible when scrolling through 6,412 cross-reference rows. Without this, users lose track of which column is which after scrolling past row 30.

`ySplit: 1` means "split after row 1", making row 1 fixed and rows 2+ scrollable.

### ExcelExportService

The core export service handles data fetching, workbook generation, and buffer creation.

```typescript
// File: src/services/export/ExcelExportService.ts (lines 92-110)
async exportAllData(): Promise<Buffer> {
  // Fetch all data from database (parallel execution)
  const [parts, vehicles, crossRefs] = await Promise.all([
    this.fetchAllRows('parts', 'acr_sku'),
    this.fetchVehiclesWithSku(),
    this.fetchCrossRefsWithSku(),
  ]);

  // Create workbook
  const workbook = new ExcelJS.Workbook();
  workbook.creator = 'ACR Automotive';
  workbook.created = new Date();

  // Add sheets in order
  this.addPartsSheet(workbook, parts);
  this.addVehiclesSheet(workbook, vehicles);
  this.addCrossRefsSheet(workbook, crossRefs);

  // Generate buffer (in-memory)
  const buffer = await workbook.xlsx.writeBuffer();
  return Buffer.from(buffer);
}
```

**Key details**:
- All table fetches run in parallel (`Promise.all`)
- Workbook created in memory (no temp files)
- Sheets added in logical order (Parts → Vehicles → Cross-refs)
- Buffer ready for HTTP response

**Joining ACR_SKU for readability**:

```typescript
// File: src/services/export/ExcelExportService.ts (lines 155-175)
private async fetchVehiclesWithSku(): Promise<any[]> {
  const allVehicles = await this.fetchAllRows('vehicle_applications', 'part_id, make, model, start_year');

  // Fetch corresponding parts to get ACR_SKU
  const partIds = [...new Set(allVehicles.map(v => v.part_id))];
  const { data: parts } = await supabase
    .from('parts')
    .select('id, acr_sku')
    .in('id', partIds);

  const partMap = new Map(parts?.map(p => [p.id, p.acr_sku]) || []);

  // Join ACR_SKU for user readability
  return allVehicles.map(vehicle => ({
    ...vehicle,
    acr_sku: partMap.get(vehicle.part_id) || '',  // Visible column
  }));
}
```

**Why join?** Vehicle Applications and Cross References sheets show `ACR_SKU` alongside `Make/Model` or `Competitor_Brand/Competitor_SKU`. This helps Humberto understand the data without having to cross-reference UUIDs manually. The hidden `_part_id` and `_acr_part_id` columns still contain UUIDs for import matching.

### Shared Constants (Single Source of Truth)

All Excel column definitions live in one file to prevent drift between export and import.

```typescript
// File: src/services/excel/shared/constants.ts (lines 203-238)

// Parts sheet columns (used by both export and import)
export const PARTS_COLUMNS = [
  {
    header: '_id',              // Excel header
    key: '_id',                 // Object property name
    width: 36,                  // Column width in characters
    hidden: true                // Hidden in Excel by default
  },
  { header: 'ACR_SKU', key: 'acr_sku', width: 15 },
  { header: 'Part_Type', key: 'part_type', width: 20 },
  // ... 5 more columns
];

// Vehicle Applications sheet columns
export const VEHICLE_APPLICATIONS_COLUMNS = [
  { header: '_id', key: '_id', width: 36, hidden: true },
  { header: '_part_id', key: '_part_id', width: 36, hidden: true },
  { header: 'ACR_SKU', key: 'acr_sku', width: 15 },
  // ... 4 more columns
];

// Cross References sheet columns
export const CROSS_REFERENCES_COLUMNS = [
  { header: '_id', key: '_id', width: 36, hidden: true },
  { header: '_acr_part_id', key: '_acr_part_id', width: 36, hidden: true },
  { header: 'ACR_SKU', key: 'acr_sku', width: 15 },
  // ... 2 more columns
];
```

**Why shared?** During initial development, export and import had separate column definitions. Export added a new column → import didn't know about it → parse error. Shared constants ensure both sides stay synchronized.

**Header-to-property conversion** handles Excel's PascalCase headers to JavaScript's snake_case properties:

```typescript
// File: src/services/excel/shared/constants.ts (lines 162-174)
export function headerToPropertyName(header: string): string {
  // Hidden ID columns: keep as-is
  if (HIDDEN_ID_COLUMNS.includes(header as any)) {
    return header.toLowerCase();  // "_id" → "_id"
  }

  // Regular columns: lowercase and normalize underscores
  return header
    .toLowerCase()              // "ACR_SKU" → "acr_sku"
    .replace(/_+/g, '_');       // "Part__Type" → "part_type" (fix double underscores)
}

// Examples:
// "ACR_SKU" → "acr_sku"
// "Part_Type" → "part_type"
// "_id" → "_id" (preserved)
// "_part_id" → "_part_id" (preserved)
```

### Performance Characteristics

From measured test runs on 9,593 total records:

**Export timing breakdown**:
- Database queries: ~1.5s (11 paginated queries in parallel)
- ExcelJS workbook generation: ~200-300ms
- Buffer conversion: ~10ms
- **Total: 1.7s - 5.5s**

**Memory usage**:
- 9,593 rows: ~2-3 MB in memory
- File size: ~500 KB (XLSX compression)
- Buffer overhead: ~2x file size during generation

**Scaling estimates**:
- 10k records: ~2-3 seconds
- 50k records: ~8-12 seconds
- 100k+ records: Consider streaming API (ExcelJS supports `stream.xlsx.WorkbookWriter`)

### Verification

```bash
# Run export test suite
npm run test:export
```

**8 automated checks**:
1. All 3 sheets exist (Parts, Vehicle Applications, Cross References)
2. Parts sheet has correct column headers
3. Hidden columns detected (using ExcelJS reader to check `column.hidden` property)
4. Parts row count matches database (877 rows)
5. Vehicle Applications sheet structure correct
6. Vehicles row count matches database (2,304 rows)
7. Cross References sheet structure correct
8. Cross-refs row count matches database (6,412 rows)

**Manual verification** (open exported file in Excel):
- Column A is hidden (right-click column B → Unhide to verify it exists)
- Header row stays visible when scrolling (frozen pane)
- Data matches database query results

---

_Last updated: January 7, 2026_
